<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push-to-Talk Voice Transcription</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f5f5f5; height: 100vh; }
        .container { display: flex; flex-direction: column; height: 100%; max-width: 1280px; margin: 0 auto; gap: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 24px; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        textarea { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; resize: none; }
        textarea:focus { outline: none; border-color: #4CAF50; }
        textarea.recording { border-color: #f44; box-shadow: 0 0 10px rgba(255,68,68,0.3); }
        .controls { display: flex; align-items: center; gap: 10px; }
        .status { flex: 1; font-style: italic; color: #888; }
        .warning { background: #fff3cd; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

    <script type="module">
        import { h, Component, render } from 'https://esm.sh/preact@10.19.3';
        import { useEffect, useRef, useState } from 'https://esm.sh/preact@10.19.3/hooks';
        import htm from 'https://esm.sh/htm@3.1.1';

        const html = htm.bind(h);

        function App() {
            const textAreaRef = useRef(null);
            const recognitionRef = useRef(null);
            const [text, setText] = useState('');
            const [interim, setInterim] = useState('');
            const [recording, setRecording] = useState(false);
            const [warning, setWarning] = useState('');
            const [key, setKey] = useState('Ctrl');
            const [keys, setKeys] = useState({ ctrl: false, shift: false });
            const [remember, setRemember] = useState(false);

            useEffect(() => {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) return setWarning('Speech recognition not supported');

                const rec = recognitionRef.current = new SR();
                rec.continuous = true;
                rec.interimResults = true;
                rec.lang = 'en-US';

                rec.onstart = () => setRecording(true);
                rec.onend = () => { setRecording(false); setInterim(''); };
                rec.onresult = (e) => {
                    let final = '', temp = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        const t = e.results[i][0].transcript;
                        if (e.results[i].isFinal) final += t; else temp = t;
                    }
                    setInterim(temp);
                    if (final) {
                        const ta = textAreaRef.current;
                        const start = ta.selectionStart, end = ta.selectionEnd;
                        const newText = ta.value.slice(0, start) + final + ' ' + ta.value.slice(end);
                        setText(newText);
                        if (remember) localStorage.setItem('push2talk_text', newText);
                        setTimeout(() => ta.setSelectionRange(start + final.length + 1, start + final.length + 1), 0);
                    }
                };
                rec.onerror = (e) => setInterim(`Error: ${e.error}`);

                // Load saved settings
                const saved = localStorage.getItem('push2talk_text');
                if (saved) { setText(saved); setRemember(true); }
                setKey(localStorage.getItem('push2talk_key') || 'Ctrl');
            }, []);

            useEffect(() => {
                const down = (e) => setKeys(k => ({ ...k, ctrl: e.key === 'Control' ? true : k.ctrl, shift: e.key === 'Shift' ? true : k.shift }));
                const up = (e) => setKeys(k => ({ ...k, ctrl: e.key === 'Control' ? false : k.ctrl, shift: e.key === 'Shift' ? false : k.shift }));
                document.addEventListener('keydown', down);
                document.addEventListener('keyup', up);
                return () => { document.removeEventListener('keydown', down); document.removeEventListener('keyup', up); };
            }, []);

            useEffect(() => {
                const shouldTalk = key === 'Shift' ? keys.shift : key === 'Ctrl+Shift' ? keys.ctrl && keys.shift : keys.ctrl;
                const rec = recognitionRef.current;
                if (!rec) return;
                try {
                    if (shouldTalk && !recording) rec.start();
                    else if (!shouldTalk && recording) rec.stop();
                } catch (e) {}
            }, [keys, key, recording]);

            const onTextChange = (e) => {
                setText(e.target.value);
                if (remember) localStorage.setItem('push2talk_text', e.target.value);
            };

            const onRememberChange = (e) => {
                const checked = e.target.checked;
                setRemember(checked);
                if (checked) localStorage.setItem('push2talk_text', text);
                else localStorage.removeItem('push2talk_text');
            };

            const onKeyChange = (e) => {
                setKey(e.target.value);
                localStorage.setItem('push2talk_key', e.target.value);
            };

            const speak = () => {
                const t = (window.getSelection()?.toString() || text).trim();
                if (t && window.speechSynthesis) {
                    speechSynthesis.cancel();
                    speechSynthesis.speak(new SpeechSynthesisUtterance(t));
                }
            };

            return html`
                <div class="container">
                    <div class="header">
                        <h1>Push-to-Talk Voice Transcription</h1>
                        <button onClick=${speak} style="background: #4CAF50; color: white;">üîä Speak</button>
                    </div>
                    ${warning && html`<div class="warning">‚ö†Ô∏è ${warning}</div>`}
                    <p>Hold <strong>${key}</strong> and speak.</p>
                    <textarea ref=${textAreaRef} value=${text} onInput=${onTextChange} class=${recording ? 'recording' : ''} />
                    <div class="controls">
                        <span>Hold:</span>
                        <select value=${key} onChange=${onKeyChange}>
                            <option>Ctrl</option>
                            <option>Shift</option>
                            <option>Ctrl+Shift</option>
                        </select>
                        <label>
                            <input type="checkbox" checked=${remember} onChange=${onRememberChange} />
                            Ask browser to save text
                        </label>
                        <span class="status">${interim}</span>
                    </div>
                </div>
            `;
        }

        render(html`<${App} />`, document.body);
    </script>
</body>
</html>